"use client";

import { useState } from "react";
import { Search, Table, BodyShort, Box, Heading, Alert, Loader } from "@navikt/ds-react";
import { useTranslations } from "next-intl";
import { formatNumber } from "@/lib/format";

interface VulnerabilitySearchResult {
  identifier: string;
  workloadName: string;
  workloadId: string;
  team: string;
  environment: string;
  repository?: string;
  riskScore: number;
  packageName: string;
}

interface VulnerabilitySearchResponse {
  results: VulnerabilitySearchResult[];
  totalCount: number;
}

export function VulnerabilitySearch() {
  const t = useTranslations("admin");
  const [searchQuery, setSearchQuery] = useState("");
  const [results, setResults] = useState<VulnerabilitySearchResult[] | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [hasSearched, setHasSearched] = useState(false);

  const handleSearch = async (query: string) => {
    setSearchQuery(query);
    
    if (!query.trim()) {
      setResults(null);
      setHasSearched(false);
      return;
    }

    setIsLoading(true);
    setError(null);
    setHasSearched(true);

    try {
      const response = await fetch(`/api/admin/vulnerability-search?q=${encodeURIComponent(query.trim())}`);
      
      if (!response.ok) {
        throw new Error("Failed to search vulnerabilities");
      }

      const data: VulnerabilitySearchResponse = await response.json();
      setResults(data.results);
    } catch (err) {
      setError(err instanceof Error ? err.message : "An error occurred");
      setResults(null);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Box>
      <Heading size="medium" level="2" spacing>
        {t("vulnerabilitySearch")}
      </Heading>
      <BodyShort spacing style={{ opacity: 0.75 }}>
        {t("vulnerabilitySearchDescription")}
      </BodyShort>

      <Box paddingBlock="space-12">
        <Search
          label={t("searchVulnerability")}
          hideLabel={false}
          placeholder={t("searchVulnerabilityPlaceholder")}
          value={searchQuery}
          onChange={handleSearch}
          size="medium"
        />
      </Box>

      {isLoading && (
        <Box padding="space-24" style={{ display: "flex", justifyContent: "center" }}>
          <Loader size="medium" title={t("searching")} />
        </Box>
      )}

      {error && (
        <Alert variant="error">
          {error}
        </Alert>
      )}

      {!isLoading && hasSearched && results !== null && (
        <>
          {results.length === 0 ? (
            <Alert variant="info">
              {t("noVulnerabilitiesFound")}
            </Alert>
          ) : (
            <Box>
              <BodyShort spacing style={{ fontWeight: 600 }}>
                {t("vulnerabilitySearchResults", { count: formatNumber(results.length) })}
              </BodyShort>
              
              <Table size="small">
                <Table.Header>
                  <Table.Row>
                    <Table.HeaderCell scope="col">{t("cveId")}</Table.HeaderCell>
                    <Table.HeaderCell scope="col">{t("teamSlug")}</Table.HeaderCell>
                    <Table.HeaderCell scope="col">{t("workloadName")}</Table.HeaderCell>
                    <Table.HeaderCell scope="col">{t("environment")}</Table.HeaderCell>
                    <Table.HeaderCell scope="col">{t("packageName")}</Table.HeaderCell>
                    <Table.HeaderCell scope="col" align="right">{t("riskScore")}</Table.HeaderCell>
                  </Table.Row>
                </Table.Header>
                <Table.Body>
                  {results.map((result, idx) => (
                    <Table.Row key={`${result.workloadId}-${result.identifier}-${idx}`}>
                      <Table.DataCell>
                        <BodyShort weight="semibold">{result.identifier}</BodyShort>
                      </Table.DataCell>
                      <Table.DataCell>{result.team}</Table.DataCell>
                      <Table.DataCell>{result.workloadName}</Table.DataCell>
                      <Table.DataCell>{result.environment}</Table.DataCell>
                      <Table.DataCell>{result.packageName}</Table.DataCell>
                      <Table.DataCell align="right">
                        <BodyShort
                          weight="semibold"
                          style={{
                            color: result.riskScore >= 150
                              ? "var(--a-text-danger)"
                              : result.riskScore >= 75
                                ? "var(--a-text-warning)"
                                : undefined,
                          }}
                        >
                          {formatNumber(result.riskScore)}
                        </BodyShort>
                      </Table.DataCell>
                    </Table.Row>
                  ))}
                </Table.Body>
              </Table>
            </Box>
          )}
        </>
      )}
    </Box>
  );
}
