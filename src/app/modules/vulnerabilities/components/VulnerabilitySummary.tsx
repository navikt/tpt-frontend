"use client";
import { useState } from "react";
import { useVulnerabilities } from "../hooks/useVulnerabilities";
import { useConfig } from "@/app/shared/hooks/useConfig";
import { Box, HStack, VStack, Heading, BodyShort, Skeleton, Alert, Button, Tooltip } from "@navikt/ds-react";
import {
  CheckmarkCircleFillIcon,
  ExclamationmarkTriangleFillIcon,
  XMarkOctagonFillIcon,
  InformationSquareFillIcon,
  ArrowsCirclepathIcon,
  CogIcon,
} from "@navikt/aksel-icons";
import TeamFilterModal from "./TeamFilterModal";
import { useTranslations } from "next-intl";

export interface BucketThreshold {
  name: string;
  minThreshold: number;
  maxThreshold: number;
}

interface BucketData {
  name: string;
  count: number;
  color: string;
  bgColor: string;
  icon: React.ReactNode;
  minThreshold: number;
  maxThreshold: number;
}

interface VulnerabilitySummaryProps {
  selectedBucket: BucketThreshold;
  onBucketSelect: (bucket: BucketThreshold) => void;
  selectedTeams: string[];
  onTeamsChange: (teams: string[]) => void;
  showAllBuckets?: boolean;
  onShowAllBucketsChange?: (show: boolean) => void;
}

const VulnerabilitySummary = ({ 
  selectedBucket, 
  onBucketSelect, 
  selectedTeams, 
  onTeamsChange,
  showAllBuckets = false,
  onShowAllBucketsChange,
}: VulnerabilitySummaryProps) => {
  const t = useTranslations();
  const { data, isLoading, isRefreshing, refresh, canRefresh, timeUntilRefresh } = useVulnerabilities();
  const { config, isLoading: configLoading } = useConfig();
  const [filterModalOpen, setFilterModalOpen] = useState(false);

  const formatTimeRemaining = (ms: number) => {
    const minutes = Math.ceil(ms / 60000);
    return `${minutes} min`;
  };

  const highThreshold = config?.thresholds.high ?? 150;
  const mediumThreshold = config?.thresholds.medium ?? 75;
  const lowThreshold = config?.thresholds.low ?? 30;

  // Calculate counts for each bucket (empty selection => show none)
  const allVulnerabilities =
    data?.teams
      .filter((team) => selectedTeams.includes(team.team))
      .flatMap((team) =>
        team.workloads.flatMap((workload) => workload.vulnerabilities)
      ) || [];

  const criticalCount = allVulnerabilities.filter(
    (v) => v.riskScore >= highThreshold
  ).length;

  const importantCount = allVulnerabilities.filter(
    (v) => v.riskScore >= mediumThreshold && v.riskScore < highThreshold
  ).length;

  const whenTimeCount = allVulnerabilities.filter(
    (v) => v.riskScore >= lowThreshold && v.riskScore < mediumThreshold
  ).length;

  const lowPriorityCount = allVulnerabilities.filter(
    (v) => v.riskScore < lowThreshold
  ).length;

  const buckets: BucketData[] = [
    {
      name: t("buckets.highPriority"),
      count: criticalCount,
      color: "var(--ax-bg-danger-strong)",
      bgColor: "var(--ax-bg-danger-soft)",
      icon: <XMarkOctagonFillIcon aria-hidden fontSize="1.5rem" style={{ color: "var(--ax-bg-danger-strong)" }} />,
      minThreshold: highThreshold,
      maxThreshold: Number.MAX_VALUE,
    },
    {
      name: t("buckets.important"),
      count: importantCount,
      color: "#e67700",
      bgColor: "var(--ax-bg-warning-soft)",
      icon: <ExclamationmarkTriangleFillIcon aria-hidden fontSize="1.5rem" style={{ color: "#e67700" }} />,
      minThreshold: mediumThreshold,
      maxThreshold: highThreshold,
    },
    {
      name: t("buckets.whenTime"),
      count: whenTimeCount,
      color: "var(--ax-bg-info-strong)",
      bgColor: "var(--ax-bg-info-soft)",
      icon: <InformationSquareFillIcon aria-hidden fontSize="1.5rem" style={{ color: "var(--ax-bg-info-strong)" }} />,
      minThreshold: lowThreshold,
      maxThreshold: mediumThreshold,
    },
    {
      name: t("buckets.lowPriority"),
      count: lowPriorityCount,
      color: "var(--ax-bg-success-strong)",
      bgColor: "var(--ax-bg-success-soft)",
      icon: <CheckmarkCircleFillIcon aria-hidden fontSize="1.5rem" style={{ color: "var(--ax-bg-success-strong)" }} />,
      minThreshold: 0,
      maxThreshold: lowThreshold,
    },
  ];

  // Filter buckets based on showAllBuckets setting
  const visibleBuckets = showAllBuckets ? buckets : buckets.slice(0, 3);
  
  // Calculate total count for visible buckets only (for proportional sizing)
  const visibleTotalCount = visibleBuckets.reduce((sum, bucket) => sum + bucket.count, 0);

  const loading = isLoading || configLoading;

  if (loading) {
    return (
      <Box
        padding="space-24"
        borderRadius="4"
        background="neutral-soft"
        style={{ marginBottom: "1.5rem" }}
      >
        <Skeleton variant="text" width="60%" height={32} />
        <div style={{ marginTop: "1rem" }}>
          <HStack gap="space-16" wrap>
            {[1, 2, 3, 4].map((i) => (
              <Skeleton key={i} variant="rounded" width={150} height={80} />
            ))}
          </HStack>
        </div>
      </Box>
    );
  }

  return (
    <Box
      padding="space-24"
      borderRadius="4"
      background="neutral-soft"
      style={{ marginBottom: "1.5rem" }}
    >
      <VStack gap="space-16">
        {/* Header with settings and refresh buttons */}
        <HStack justify="space-between" align="center">
          <Alert variant="warning" size="small" style={{ flex: 1 }}>
            {t("summary.priorityWarning")}
          </Alert>
          <HStack gap="space-8" style={{ marginLeft: "1rem" }}>
            <Tooltip content={t("summary.filterTeam")}>
              <Button
                variant="tertiary"
                size="small"
                icon={<CogIcon aria-hidden />}
                onClick={() => setFilterModalOpen(true)}
              >
                {t("summary.settings")}
              </Button>
            </Tooltip>
            <Tooltip content={canRefresh ? t("summary.fetchNewData") : `${t("summary.wait")} ${formatTimeRemaining(timeUntilRefresh)}`}>
              <Button
                variant="tertiary"
                size="small"
                icon={<ArrowsCirclepathIcon aria-hidden />}
                onClick={refresh}
                disabled={!canRefresh}
                loading={isRefreshing}
              >
                {t("summary.refresh")}
              </Button>
            </Tooltip>
          </HStack>
        </HStack>

        {/* Visual bar showing proportion */}
        {visibleTotalCount > 0 && (
          <div
            style={{
              display: "flex",
              height: "12px",
              borderRadius: "6px",
              overflow: "hidden",
              width: "100%",
            }}
          >
            {visibleBuckets.map((bucket, index) => {
              const percentage = (bucket.count / visibleTotalCount) * 100;
              if (percentage === 0) return null;
              return (
                <div
                  key={index}
                  style={{
                    width: `${percentage}%`,
                    backgroundColor: bucket.color,
                    transition: "width 0.3s ease",
                  }}
                  title={`${bucket.name}: ${bucket.count} (${Math.round(percentage)}%)`}
                />
              );
            })}
          </div>
        )}

        {/* Bucket cards */}
        <HStack gap="space-16" wrap>
          {visibleBuckets.map((bucket, index) => {
            const isSelected = selectedBucket.name === bucket.name;
            const isCritical = bucket.name === t("buckets.highPriority");
            
            // Adjust sizing based on number of visible buckets
            const isShowingAll = visibleBuckets.length === 4;
            const criticalFlex = isShowingAll ? "1.5 1 180px" : "2 1 200px";
            const normalFlex = isShowingAll ? "1 1 140px" : "1.5 1 170px";
            const criticalMinWidth = isShowingAll ? "180px" : "200px";
            const normalMinWidth = isShowingAll ? "140px" : "170px";
            const criticalMaxWidth = isShowingAll ? "250px" : "300px";
            const normalMaxWidth = isShowingAll ? "200px" : "250px";
            
            return (
              <Box
                key={index}
                padding={isCritical ? "space-20" : "space-12"}
                borderRadius="4"
                onClick={() => onBucketSelect({ 
                  name: bucket.name, 
                  minThreshold: bucket.minThreshold, 
                  maxThreshold: bucket.maxThreshold 
                })}
                style={{
                  backgroundColor: bucket.bgColor,
                  border: isSelected ? `3px solid ${bucket.color}` : "1px solid var(--ax-border-neutral-subtle)",
                  minWidth: isCritical ? criticalMinWidth : normalMinWidth,
                  flex: isCritical ? criticalFlex : normalFlex,
                  maxWidth: isCritical ? criticalMaxWidth : normalMaxWidth,
                  cursor: "pointer",
                  transition: "border 0.2s ease, transform 0.2s ease, flex 0.3s ease, min-width 0.3s ease",
                  opacity: isCritical ? 1 : 0.75,
                  transform: isCritical ? "scale(1)" : "scale(0.95)",
                }}
              >
                <HStack gap="space-8" align="center">
                  {bucket.icon}
                  <VStack gap="space-0">
                    <BodyShort size={isCritical ? "medium" : "small"} weight="semibold">
                      {bucket.name}
                    </BodyShort>
                    <Heading size={isCritical ? "large" : "small"}>{bucket.count}</Heading>
                  </VStack>
                </HStack>
              </Box>
            );
          })}
        </HStack>
      </VStack>
      <TeamFilterModal
        open={filterModalOpen}
        onClose={() => setFilterModalOpen(false)}
        selectedTeams={selectedTeams}
        onTeamsChange={onTeamsChange}
        showAllBuckets={showAllBuckets}
        onShowAllBucketsChange={onShowAllBucketsChange}
      />
    </Box>
  );
};

export default VulnerabilitySummary;
